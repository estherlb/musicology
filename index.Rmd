---
title: "  Music and Movies | Computational Musicology 2021"
author: "Esther L. Bakels <img src=\"logo.png\" style=\"float: left;\" width=\"35;\"/>"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    storyboard: true
    theme: flatly
---

```{r}
library(tidyverse)
library(spotifyr)
library(ggthemes)
library(ggrepel)
library(compmus)
library(flexdashboard)
library(shiny)
library(plotly)
library(knitr)
```


Homework 
==============================

```{r}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )
```
```{r}
twenty_five <-
  get_tidy_audio_analysis("0yIM3MDx8UTwueyoZJobsb") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )
```
```{r}
twenty_five %>% 
  compmus_match_pitch_template(
    chord_templates,         # Change to chord_templates if descired
    method = "manhattan",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "Chords", title="The Portrait")
```








Introduction
==============================



#### Music and Movies

<img align="right" src="musicmovie.jpg">

Almost every movie has music in it. These soundtracks often play in the background of a movie, so you would expect the music is calmer than music you'd listen to. On the other hand, maybe there are some features in the music that are not so different from your own music. I made three playlists:

* **Theme songs:** A playlist with different theme songs, you could say these songs are the most important to a movie. _Tracks: 103_
* **More soundtracks:** A playlist with more soundtracks, other than a themesong, movies have a lot of other music in it. _Tracks: 196_
* **My songs:** An old playlist of mine where I stored my favorite songs over the last couple of years. _Tracks: 70_

My goal is to examine different features, compare them to one another and search for a feature that isn't that different from my music. When I find that feature, I hope to find the themesong that corresponds the most to my favorite songs.




Visualisation {.storyboard}
=============================================


### The feature **Tempo**.

```{r}
CM_themes <- get_playlist_audio_features("","6ubQSyY5AOAZOTLaBUFHWD")
CM_soundtrack <- get_playlist_audio_features("","5Lo1O7pS5PWc9z6UuplHyX")
CM_faves <- get_playlist_audio_features("","0QzlUG13KFnSFOqgxeEli2")
```
```{r}
songs <-
  bind_rows(
    CM_themes %>% mutate(category = "A. Theme songs"),
    CM_faves %>% mutate(category = "C. My songs"),
    CM_soundtrack %>% mutate(category = "B. more soundtracks")
  )
```
```{r}
movie_songs <-
  bind_rows(
    CM_themes %>% mutate(category = "A. Theme songs"),
    CM_soundtrack %>% mutate(category = "B. more soundtracks")
  )
```
```{r}
songs %>%
  ggplot(aes(x = category, y = tempo)) +
  geom_boxplot(aes(fill = category), show.legend = FALSE)+
  theme_wsj()+
  labs(title = "Tempo")+
  geom_text_repel(data = subset(movie_songs,tempo > 200), aes(label = track.name), size=3)

```

---

###### Boxplot 1: 
The median of the different categories is somewhat **the same**. The 50% around the median is differs more in category C, my songs. Category B has the lowest median, but an outlier with the highest tempo of all categories. The outlier is _The Portrait - James Horner_.


### The feature **Energy**.

```{r}
songs %>%
  ggplot(aes(x = category, y = energy)) +
  geom_boxplot(aes(fill = category), show.legend = FALSE)+
  theme_wsj()+
  labs(title = "Energy")+
  geom_text_repel(data = subset(movie_songs, tempo > 200), aes(label = track.name), size=3)

```

---

###### Boxplot 2: 
The median of the different catogories is somewhat the **same** for **theme songs** and **more soundtracks**, but way **higher** for **my songs**. The median of category A is higher than B, this is maybe because theme songs are the main song of the movie. Category B also includes songs that are used as more background music in movies. The outlier "The Portrait" from boxplot 1 is this time one of the lowest few. 



### How did **Tempo** in soundtracks change over the years?



```{r, results='hide'}
# Dataframe
df <- CM_themes %>%
 select(track.album.release_date, energy, tempo) %>%
 mutate(
  year = as.Date(track.album.release_date, format="%Y"),
)

# summarize
by_year <- df %>%
    group_by(year) %>%
    summarize(energy=median(energy), tempo=median(tempo))
by_year
```



```{r}
ggplot(by_year, aes(x=year, y=tempo))+
  geom_smooth(color= "#FC5959")+
  labs(title="Tempo over the years", subtitle = "Theme songs")+
  ylim(c(50,200))+
  theme_wsj()
```

---

###### Graph 1:
The median of tempo is plotted over the years. In boxplot 1, category A, we saw that the 50% around the median was small. In this graph, we can see that the 50% is so small because the tempo did not really change over the years. 



### How did **Energy** in soundtracks change over the years?


```{r }
# plot

ggplot(by_year, aes(x=year, y=energy))+
  geom_smooth(color= "#FC5959")+
  labs(title="Energy over the years", subtitle = "Theme songs")+
  theme_wsj()

```

---

###### Graph 2:
The median is plotted over the years. In boxplot 2, category A, we saw that the 50% around the median was a lot bigger than boxplot 1. In this graph, we can see that the 50% is so big because the tempo did really change over the years. In the early stages, energy was at its highest point, but decreased rapidly. but around the 2000, energy has a turning point, and started to increase again.



### How popular were these songs? **Tempo** and **Energy** together.

```{r}
vs <- ggplot(songs, aes(energy, tempo, colour = category, size = track.popularity)) + 
  geom_point()+
  theme_solarized()+
  labs(title = "Tempo vs. Energy")

ggplotly(vs)


```

---

###### Graph 3:
If you click on A and B, only C will show. You'll see that a red cluster is formed in the right side of the plot. A and B together are more active on the left side.You don't see clusters forming in the up or down side. Tempo seems equally distributed for all the three playlists, unlike the other feature energy. We also saw this in the visualisation per feature. 



Conclusion
==========================


Column 1 
----------------------------------------------

### Investigating tracks
#### Which song did not fit in?

We now have an overall view of the playlists. The features **Tempo** and **Energy** showed different relations between the playlists. In the feature Tempo, the medians of all playlists were close together. Energy on the other hand, showed that the median of My Songs was higher than that of the soundtrack playlists. To understand the corpus better, we are going to dive in the soundtrack playlists, Theme songs and More Soundtracks, and hopefully discover some interesting findings. Songs that do not fit in the bunch are interesting to investigate. I would also like to investigate the similarity between playlists, so a track that blends in is also not a bad choice. 
\n \n

The boxplots of Tempo showed that _The Portrait - James Horner_ was an **outlier** in the More Soundtracks playlist.It wasn't only an outlier in that playlist, it deviated from all three playlists. A boxplot also shows a median, a track can be seen as the midpoint of the dataset. But to find a song that blends in, I will use another method that I like more in the column on the right. 

COlumn 2 
-----------------------------

### What movie should I watch?
#### Which song fits in?


```{r}
my_songs_mean <- CM_faves %>%
  summarise(
    mean_tempo_my_songs = mean(tempo)
  )

```

As was shown in the visualisations, the (median) tempo of the different playlists didn't really differ from each other. To know what soundtrack would fit the best in my favorite songs playlist, the average tempo of my favorite songs were calculated. \
The mean tempo of my favorite songs is: `r my_songs_mean`. \
One of the songs in the theme song playlist should correspond the most with this mean tempo. \
The corresponding track by this song is:

```{r}
# Print which theme song is closest to mean tempo of my songs
Themes_tempo <- CM_themes[,"tempo"]
Values <- abs(Themes_tempo-c(my_songs_mean))
Min_value = min(Values)
Index <- which(Values==Min_value)
endsong <- CM_themes[Index, "track.name"]

kable(endsong)

```

I will use the track _Alice's Theme - Danny Elfman_.

<img src="Cheshire_head.png">




Grammys {.storyboard}
============================
```{r}
Alice <-
  get_tidy_audio_analysis("11liAe3FvMGspJ9x3a1xw4") %>% # Change URI.
  compmus_align(bars, segments) %>%                     # Change `bars`
  select(bars) %>%                                      #   in all three
  unnest(bars) %>%                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )
```
```{r}
Alice_cep <- Alice %>%
  compmus_gather_timbre() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title="Alice's Theme" ) +
  scale_fill_viridis_c() +                              
  theme_classic()
```
```{r}
alice_theme <-
  get_tidy_audio_analysis("5yJ4g5wiv77VzuhidvAnJ6") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

Alice_chroma <- alice_theme %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title="Alice's Theme") +
  theme_classic() +
  scale_fill_viridis_c()
```
```{r}
Alice_ssm <- Alice %>%
  compmus_self_similarity(timbre, "cosine") %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "", title="Alice's Theme")
```
```{r}
Titanic <-
  get_tidy_audio_analysis("0yIM3MDx8UTwueyoZJobsb") %>% # Change URI.
  compmus_align(sections, segments) %>%                     # Change `bars`
  select(sections) %>%                                      #   in all three
  unnest(sections) %>%                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )
```
```{r}
Titanic_cep <- Titanic %>%
  compmus_gather_timbre() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title="The Portrait" ) +
  scale_fill_viridis_c() +                              
  theme_classic()

```
```{r}
portrait <-
  get_tidy_audio_analysis("0yIM3MDx8UTwueyoZJobsb") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

Titanic_chroma <- portrait %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title="The Portrait") +
  theme_classic() +
  scale_fill_viridis_c()
```
```{r}
Titanic_ssm <- Titanic %>%
  compmus_self_similarity(timbre, "cosine") %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "", title="The Portrait")
```

### Chromagrams 

```{r}
library(grid)
library(gridExtra)


grid.arrange(Alice_chroma, Titanic_chroma, nrow = 2)

```

---

On the left are the chromagrams from Alice's Theme and The Portrait shown. 

**Alice's Theme - Danny Elfman:** 
The yellow places are the pitches that occur the most in the tracks. Alice's Theme has a lot of "C" in the first few seconds. Soon "A" takes over. The chromagram overall looks a bit messy because all the different pitches are used.

**The Portrait - James Horner:**
The pitches used in this track are more clear. In the first three minutes of the song, seven different pitches are used ("C", "D", "E", "F", "G", "A" and "A#"). After three minutes, "D", "E" and "A" stay present, but the other four pitches go one up. 


### Cepstrograms
```{r}
grid.arrange(Alice_cep, Titanic_cep, nrow = 2)
```

---

On the left are the cepstrograms from Alice's Theme and The Portrait shown. 


### Self-Similarity matrix
```{r}
grid.arrange(Alice_ssm, Titanic_ssm, nrow = 1)
```

---

On the left are the self-similarity matrices from Alice's Theme and The Portrait shown. 

**Alice's Theme**
You can see a chessboard pattern.

**The Portrait**
The yellow lines in the SSM show that the end is very different from the rest of the song. This is because this song has a fade out at the end, were the last seconds are completely silent. A long silence isn't in other parts of the song of course, so a yellow line appeares. 
